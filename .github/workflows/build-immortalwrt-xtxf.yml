---
name: Build ImmortalWrt for ZBT Z8102AX V2 (512MB Flash)

on:
  workflow_dispatch:
    inputs:
      clean_disk_space:
        description: 'Clean disk space before build (清除磁盘空间以释放空间)'
        required: true
        default: true
        type: boolean
  push:
    branches: [main, master]
    paths:
      - 'target/linux/mediatek/dts/mt7981b-zbtlink-zbt-z8102ax-v2.dts'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Free up disk space
        # yamllint disable-line rule:line-length
        if: github.event_name == 'push' || github.event.inputs.clean_disk_space == 'true'
        run: |
          echo "Disk space before cleanup:"
          df -h
          # Remove unnecessary software to free up disk space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/share/swift

          # 清理Docker镜像和容器
          docker images -q | xargs -r docker rmi 2>/dev/null || true

          # Clean apt cache
          sudo apt-get clean

          echo "Disk space after cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: 'custom'

      - name: Clone ImmortalWrt v24.10.4
        # yamllint disable rule:line-length
        run: |
          git clone --depth=1 --branch=v24.10.4 \
            https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          # 添加自定义源（如果需要）
          echo "src-git custom https://github.com/${{ github.repository }}.git;main" >> feeds.conf.default
          # 添加 qmodem 模组管理插件源
          echo "src-git qmodem https://github.com/bxyun0/qmodem.git;main" >> feeds.conf.default
        # yamllint enable rule:line-length

      - name: Copy custom DTS file
        # yamllint disable rule:line-length
        run: |
          # 创建必要的目录结构
          mkdir -p immortalwrt/target/linux/mediatek/dts/
          # 复制DTS文件
          cp custom/target/linux/mediatek/dts/mt7981b-zbtlink-zbt-z8102ax-v2.dts immortalwrt/target/linux/mediatek/dts/
          echo "DTS文件已复制"
        # yamllint enable rule:line-length

      - name: Update filogic.mk with 512MB device definition
        run: |
          cd immortalwrt
          # 在filogic.mk中追加512MB设备定义
          cat >> target/linux/mediatek/image/filogic.mk << 'EOF'

          # ZBT Z8102AX V2 (512MB Flash version)
          define Device/zbtlink_zbt-z8102ax-v2-512m
            DEVICE_VENDOR := Zbtlink
            DEVICE_MODEL := ZBT-Z8102AX-V2
            DEVICE_VARIANT := 512MB Flash
            DEVICE_DTS := mt7981b-zbtlink-zbt-z8102ax-v2
            DEVICE_DTS_DIR := ../dts
            DEVICE_PACKAGES := kmod-mt7915e kmod-mt7981-firmware \
              mt7981-wo-firmware kmod-usb3 kmod-usb-net-qmi-wwan \
              kmod-usb-serial-option kmod-usb-net-rndis kmod-usb-wwan \
              luci-app-mwan3 kmod-usb-net-sierrawireless \
              kmod-usb-serial-qualcomm kmod-usb-acm \
              kmod-usb-net-cdc-ether kmod-usb-net-cdc-mbim \
              kmod-usb-net-cdc-ncm kmod-usb-net-huawei-cdc-ncm

            KERNEL_IN_UBI := 1
            UBINIZE_OPTS := -E 5
            BLOCKSIZE := 128k
            PAGESIZE := 2048
            IMAGE_SIZE := 506432k
            IMAGES += factory.bin
            IMAGE/factory.bin := append-ubi | check-size $$(IMAGE_SIZE)
            IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
            DEVICE_COMPAT_VERSION := 1.1
            DEVICE_COMPAT_MESSAGE := Partition layout has been changed \
              for 512MB Flash
          endef
          TARGET_DEVICES += zbtlink_zbt-z8102ax-v2-512m
          EOF

      - name: Cache downloads
        uses: actions/cache@v4
        with:
          path: immortalwrt/dl
          key: dl-${{ hashFiles('immortalwrt/feeds.conf.default') }}
          restore-keys: |
            dl-

      - name: Cache feeds
        uses: actions/cache@v4
        with:
          path: |
            immortalwrt/feeds
            immortalwrt/package/feeds
          key: feeds-${{ hashFiles('immortalwrt/feeds.conf.default') }}
          restore-keys: |
            feeds-

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-immortalwrt-${{ github.sha }}
          restore-keys: |
            ccache-immortalwrt-

      - name: Setup build environment
        run: |
          echo "Disk space before setup:"
          df -h

          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          echo "Disk space after feeds update:"
          df -h

          # 安装编译依赖
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ \
            gawk gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3 python3-selinux python3-pip rsync unzip \
            zlib1g-dev file wget qemu-utils upx libelf-dev device-tree-compiler

          # Setup ccache
          mkdir -p ~/.ccache
          echo "max_size = 5.0G" > ~/.ccache/ccache.conf
          echo "compression = true" >> ~/.ccache/ccache.conf

          echo "Disk space after dependency installation:"
          df -h

      - name: Configure build
        run: |
          cd immortalwrt
          # 创建优化的基础配置，减少不必要的软件包以加快构建速度
          cat > .config << 'EOF'
          # Target System
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_zbtlink_zbt-z8102ax-v2-512m=y

          # Image Configuration
          CONFIG_TARGET_ROOTFS_PARTSIZE=450
          CONFIG_TARGET_ROOTFS_SQUASHFS=y
          CONFIG_TARGET_ROOTFS_INITRAMFS=y
          CONFIG_TARGET_KERNEL_PARTSIZE=16

          # ================== Build Optimization ==================
          CONFIG_CCACHE=y

          # ================== NMBM & NAND 修复核心 ==================
          CONFIG_MTD_NAND_MTK=y
          CONFIG_MTD_NAND_MTK_SPI=y
          CONFIG_MTD_SPI_NAND=y
          CONFIG_MTD_NMBM=y
          CONFIG_MTD_NMBM_MTD=y
          # Debug options removed to speed up build and reduce firmware size
          # CONFIG_MTD_NMBM_DEBUG is not set
          # CONFIG_MTD_NMBM_DEBUG_VERBOSE is not set
          CONFIG_MTD_NMBM_CREATE=y
          CONFIG_MTD_NMBM_USE_CMDLINE_PARAMS=y
          CONFIG_MTD_UBI_FASTMAP=y
          CONFIG_MTD_UBI_GLUEBI=y

          # ================== 内核模块 ==================
          CONFIG_PACKAGE_kmod-mtd=y
          CONFIG_PACKAGE_kmod-mtd-rw=y
          CONFIG_PACKAGE_kmod-mtd-ubi=y
          CONFIG_PACKAGE_kmod-mtd-ubi-block=y
          CONFIG_PACKAGE_kmod-nand=y
          CONFIG_PACKAGE_kmod-nand-raw=y
          CONFIG_PACKAGE_kmod-nand-raw-mtk=y
          CONFIG_PACKAGE_kmod-spi-nand=y
          CONFIG_PACKAGE_kmod-mtd-spi-nand=y
          CONFIG_PACKAGE_kmod-loop=y

          # ================== MTD/UBI 工具（精简版）==================
          CONFIG_PACKAGE_mtd-utils=y
          CONFIG_PACKAGE_mtd-utils-flash_erase=y
          CONFIG_PACKAGE_mtd-utils-ubinize=y
          CONFIG_PACKAGE_mtd-utils-ubiformat=y

          # ================== U-Boot 工具 ==================
          CONFIG_PACKAGE_uboot-envtools=y

          # ================== 基础网络工具 ==================
          CONFIG_PACKAGE_wget-ssl=y
          CONFIG_PACKAGE_curl=y
          CONFIG_PACKAGE_libustream-openssl=y

          # ================== 基础系统工具 ==================
          CONFIG_PACKAGE_bash=y
          CONFIG_PACKAGE_coreutils-base64=y

          # ================== LuCI (最小化) ==================
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          CONFIG_PACKAGE_luci-app-firewall=y
          CONFIG_PACKAGE_luci-app-opkg=y

          # ================== 基础网络诊断 ==================
          CONFIG_PACKAGE_iputils-ping=y
          CONFIG_PACKAGE_traceroute=y


          # ================== USB 支持（基础）==================
          CONFIG_PACKAGE_kmod-usb-core=y
          CONFIG_PACKAGE_kmod-usb2=y
          CONFIG_PACKAGE_kmod-usb3=y

          # ================== 内核命令行参数 ==================
          CONFIG_KERNEL_CMDLINE="console=ttyS0,115200n1 loglevel=8 earlycon=uart8250,mmio32,0x11002000 ubi.mtd=ubi root=/dev/ubi0_0 rootfstype=squashfs ro nmbm=1 nmbm_force_create=1 nmbm_force_no_bbt=1"

          # ================== QModem 相关 ==================
          CONFIG_PACKAGE_luci-app-qmodem=y
          CONFIG_PACKAGE_luci-app-qmodem-sms=y
          CONFIG_PACKAGE_luci-app-qmodem-mwan=y
          CONFIG_PACKAGE_luci-app-qmodem-ttl=y
          CONFIG_PACKAGE_kmod-usb-serial=y
          CONFIG_PACKAGE_kmod-usb-serial-option=y
          CONFIG_PACKAGE_kmod-usb-serial-wwan=y
          CONFIG_PACKAGE_comgt-ncm=y
          CONFIG_PACKAGE_uqmi=y

          # ================== 防火墙/NAT（精简）==================
          CONFIG_PACKAGE_kmod-ipt-nat=y
          CONFIG_PACKAGE_kmod-ipt-fullconenat=y

          # ================== DNS/DHCP ==================
          CONFIG_PACKAGE_dnsmasq-full=y
          CONFIG_PACKAGE_dnsmasq_full_dhcp=y
          CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y

          # ================== WiFi ==================
          CONFIG_PACKAGE_hostapd-common=y
          CONFIG_PACKAGE_wpad-openssl=y
          EOF

          # 应用默认配置，这将自动解析并添加上述包的依赖
          make defconfig

      - name: Build firmware
        run: |
          cd immortalwrt
          echo "Available disk space before build:"
          df -h

          # Use optimal number of jobs based on available cores
          # GitHub Actions provides 2-4 cores, use nproc to auto-detect
          JOBS=$(($(nproc) + 1))
          echo "Building with ${JOBS} parallel jobs ($(nproc) CPU cores detected)"
          
          # Monitor disk space in background
          (while true; do
            echo "=== Disk space check at $(date +%H:%M:%S) ==="
            df -h | grep -E "Filesystem|/dev/root"
            sleep 300
          done) &
          MONITOR_PID=$!

          # Build with optimized parallelization
          # First try with full parallelization, fall back to single job on failure
          make -j${JOBS} V=s || make -j1 V=s
          
          # Stop disk monitor
          kill $MONITOR_PID 2>/dev/null || true

          echo "Available disk space after build:"
          df -h

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-zbt-z8102ax-v2-512m-xf
          path: immortalwrt/bin/targets/mediatek/filogic/
          retention-days: 7
