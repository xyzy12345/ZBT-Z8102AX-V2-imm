---
name: Build ImmortalWrt for ZBT Z8102AX V2 (512MB Flash) with FIP and U-Boot

on:
  workflow_dispatch:
    inputs:
      clean_disk_space:
        description: 'Clean disk space before build (清除磁盘空间以释放空间)'
        required: true
        default: true
        type: boolean
  push:
    branches: [main, master]
    paths:
      - 'target/linux/mediatek/dts/mt7981b-zbtlink-zbt-z8102ax-v2.dts'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Free up disk space
        # yamllint disable-line rule:line-length
        if: github.event_name == 'push' || github.event.inputs.clean_disk_space == 'true'
        run: |
          echo "Disk space before cleanup:"
          df -h
          # Remove unnecessary software to free up disk space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/share/swift

          # Clean up Docker images and containers
          docker images -q | xargs -r docker rmi 2>/dev/null || true

          # Clean apt cache
          sudo apt-get clean

          echo "Disk space after cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: 'custom'

      - name: Clone ImmortalWrt v24.10.4
        # yamllint disable rule:line-length
        run: |
          git clone --depth=1 --branch=v24.10.4 \
            https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          # 添加自定义源（如果需要）
          echo "src-git custom https://github.com/${{ github.repository }}.git;main" >> feeds.conf.default
          # 添加 qmodem 模组管理插件源
          echo "src-git qmodem https://github.com/bxyun0/qmodem.git;main" >> feeds.conf.default
        # yamllint enable rule:line-length

      - name: Copy custom DTS file
        # yamllint disable rule:line-length
        run: |
          # 创建必要的目录结构
          mkdir -p immortalwrt/target/linux/mediatek/dts/
          # 复制DTS文件
          cp custom/target/linux/mediatek/dts/mt7981b-zbtlink-zbt-z8102ax-v2.dts immortalwrt/target/linux/mediatek/dts/
          echo "DTS文件已复制"
        # yamllint enable rule:line-length

      - name: Update filogic.mk with 512MB device definition
        run: |
          cd immortalwrt
          # 在filogic.mk中追加512MB设备定义
          cat >> target/linux/mediatek/image/filogic.mk << 'EOF'

          # ZBT Z8102AX V2 (512MB Flash version)
          define Device/zbtlink_zbt-z8102ax-v2-512m
            DEVICE_VENDOR := Zbtlink
            DEVICE_MODEL := ZBT-Z8102AX-V2
            DEVICE_VARIANT := 512MB Flash
            DEVICE_DTS := mt7981b-zbtlink-zbt-z8102ax-v2
            DEVICE_DTS_DIR := ../dts
            DEVICE_PACKAGES := kmod-mt7915e kmod-mt7981-firmware \
              mt7981-wo-firmware kmod-usb3 kmod-usb-net-qmi-wwan \
              kmod-usb-serial-option kmod-usb-net-rndis kmod-usb-wwan \
              luci-app-mwan3 kmod-usb-net-sierrawireless \
              kmod-usb-serial-qualcomm kmod-usb-acm \
              kmod-usb-net-cdc-ether kmod-usb-net-cdc-mbim \
              kmod-usb-net-cdc-ncm kmod-usb-net-huawei-cdc-ncm

            KERNEL_IN_UBI := 1
            UBINIZE_OPTS := -E 5
            BLOCKSIZE := 128k
            PAGESIZE := 2048
            IMAGE_SIZE := 506432k
            IMAGES += factory.bin
            IMAGE/factory.bin := append-ubi | check-size $$(IMAGE_SIZE)
            IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
            DEVICE_COMPAT_VERSION := 1.1
            DEVICE_COMPAT_MESSAGE := Partition layout has been changed \
              for 512MB Flash
          endef
          TARGET_DEVICES += zbtlink_zbt-z8102ax-v2-512m
          EOF

      - name: Setup build environment
        run: |
          echo "Disk space before setup:"
          df -h

          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          echo "Disk space after feeds update:"
          df -h

          # 安装编译依赖
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ \
            gawk gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3 python3-selinux python3-pip rsync unzip \
            zlib1g-dev file wget qemu-utils upx libelf-dev

          echo "Disk space after dependency installation:"
          df -h

      - name: Configure build
        run: |
          cd immortalwrt
          # 创建基础配置，包含您需要的软件包
          cat > .config << 'EOF'
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_zbtlink_zbt-z8102ax-v2-512m=y
          
          # 为512MB Flash设置足够的根文件系统分区大小（约450MB）
          CONFIG_TARGET_ROOTFS_PARTSIZE=450
          CONFIG_TARGET_ROOTFS_SQUASHFS=y
          
          # 基础LuCI
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          CONFIG_PACKAGE_luci-theme-argon=y
          
          # QModem 模组管理插件
          CONFIG_PACKAGE_luci-app-qmodem=y
          CONFIG_PACKAGE_luci-app-qmodem-sms=y
          CONFIG_PACKAGE_luci-app-qmodem-mwan=y
          CONFIG_PACKAGE_luci-app-qmodem-ttl=y
          
          # 可选：大型应用（建议刷机后在线安装，如需集成请取消注释）
          # CONFIG_PACKAGE_luci-app-openclash=y
          # CONFIG_PACKAGE_adguardhome=y
          
          # USB 驱动
          CONFIG_PACKAGE_kmod-usb2=y
          CONFIG_PACKAGE_kmod-usb-ohci=y
          
          # 网络驱动
          CONFIG_PACKAGE_kmod-ipt-extra=y
          CONFIG_PACKAGE_kmod-ipt-nat6=y
          CONFIG_PACKAGE_kmod-ipt-nat=y
          CONFIG_PACKAGE_kmod-ipt-physdev=y
          CONFIG_PACKAGE_kmod-nf-ipvs=y
          CONFIG_PACKAGE_kmod-veth=y
          CONFIG_PACKAGE_kmod-ipt-fullconenat=y
          CONFIG_PACKAGE_kmod-nft-tproxy=y
          CONFIG_PACKAGE_kmod-tun=y
          CONFIG_PACKAGE_kmod-inet-diag=y
          CONFIG_PACKAGE_kmod-fs-btrfs=y
          CONFIG_PACKAGE_kmod-netlink-diag=y
          
          # 工具
          CONFIG_PACKAGE_coreutils=y
          CONFIG_PACKAGE_coreutils-nohup=y
          CONFIG_PACKAGE_dnsmasq-full=y
          
          # 添加编译工具链
          CONFIG_SDK=y
          CONFIG_IMAGEOPT=y
          CONFIG_IB=y
          CONFIG_COLLECT_KERNEL_DEBUG=y
          EOF

          # 应用默认配置，这将自动解析并添加上述包的依赖
          make defconfig

      - name: Validate build environment
        run: |
          cd immortalwrt
          echo "=== Build Environment Validation ==="
          echo "Checking required tools..."
          which gcc g++ make || { echo "ERROR: Basic build tools missing!"; exit 1; }
          echo "GCC version:"
          gcc --version | head -1
          echo "Make version:"
          make --version | head -1
          
          echo "Checking U-Boot package structure..."
          if [ ! -d "package/boot/uboot-mediatek" ]; then
            echo "ERROR: uboot-mediatek package not found!"
            exit 1
          fi
          ls -la package/boot/uboot-mediatek/
          
          echo "Checking for problematic patches..."
          if [ -f "package/boot/uboot-mediatek/patches/102-mtd-spinand-esmt-add-support-for-F50L1G41LC.patch" ]; then
            echo "WARNING: Problematic patch still exists, will be removed in build step"
          else
            echo "OK: Problematic patch not present"
          fi
          
          echo "Checking .config file..."
          if [ ! -f ".config" ]; then
            echo "ERROR: .config file not found!"
            exit 1
          fi
          echo "OK: .config file exists"
          grep -c "^CONFIG_" .config || echo "Configuration lines found"
          
          echo "Checking target device configuration..."
          if grep -q "CONFIG_TARGET_mediatek_filogic_DEVICE_zbtlink_zbt-z8102ax-v2-512m=y" .config; then
            echo "OK: Target device configured correctly"
          else
            echo "ERROR: Target device not configured!"
            exit 1
          fi
          
          echo "=== Validation Complete ==="

      - name: Build firmware
        run: |
          cd immortalwrt
          echo "Available disk space before build:"
          df -h

          # 移除有问题的 U-Boot 补丁 (Known issue in v24.10.4)
          # Workaround for ImmortalWrt issue #2152: This patch fails to apply
          # cleanly to U-Boot 2024.10 SPI-NAND sources, causing build failures
          echo "Removing problematic U-Boot patch..."
          rm -f package/boot/uboot-mediatek/patches/102-mtd-spinand-esmt-add-support-for-F50L1G41LC.patch || true
          
          # Verify patch removal
          echo "Verifying patches directory..."
          ls -la package/boot/uboot-mediatek/patches/ 2>/dev/null || echo "No patches directory found"
          
          # 先编译 U-Boot 和 FIP (使用正确的包路径)
          echo "=== Building U-Boot and FIP ==="
          echo "Starting U-Boot build at: $(date)"
          if ! make -j1 V=s package/boot/uboot-mediatek/compile 2>&1 | tee /tmp/uboot_build.log; then
            echo "=== U-Boot build failed! Last 100 lines of output: ==="
            tail -100 /tmp/uboot_build.log
            echo "=== Retrying U-Boot build... ==="
            sleep 3
            if ! make -j1 V=s package/boot/uboot-mediatek/compile 2>&1 | tee /tmp/uboot_build_retry.log; then
              echo "=== U-Boot retry also failed! Last 100 lines: ==="
              tail -100 /tmp/uboot_build_retry.log
              exit 1
            fi
          fi
          echo "U-Boot build completed at: $(date)"
          
          # 然后编译整个固件
          echo "=== Building full firmware ==="
          echo "Starting firmware build at: $(date)"
          if ! make -j2 V=s 2>&1 | tee /tmp/firmware_build.log; then
            echo "=== Firmware build with -j2 failed, last 100 lines: ==="
            tail -100 /tmp/firmware_build.log
            echo "=== Retrying with -j1... ==="
            if ! make -j1 V=s 2>&1 | tee /tmp/firmware_build_j1.log; then
              echo "=== Firmware build with -j1 also failed! Last 200 lines: ==="
              tail -200 /tmp/firmware_build_j1.log
              exit 1
            fi
          fi
          echo "Firmware build completed at: $(date)"

          echo "Available disk space after build:"
          df -h

      - name: 查找并准备 U-Boot 和 FIP 文件
        run: |
          cd immortalwrt
          echo "查找 U-Boot 和 FIP 文件..."
          
          # 查找 U-Boot 相关文件
          find bin/targets -name "*uboot*" -type f | while read file; do
            echo "Found U-Boot file: $file"
            cp "$file" ${{ github.workspace }}/ 2>/dev/null || true
          done
          
          # 查找 FIP 相关文件
          find bin/targets -name "*fip*" -type f | while read file; do
            echo "Found FIP file: $file"
            cp "$file" ${{ github.workspace }}/ 2>/dev/null || true
          done
          
          # 查看构建目录内容
          echo "列出构建目录中的 U-Boot/FIP 相关文件:"
          ls -la bin/targets/mediatek/filogic/uboot* bin/targets/mediatek/filogic/fip* 2>/dev/null || true
          
          # 创建 U-Boot/FIP 打包目录
          mkdir -p ${{ github.workspace }}/uboot_fip
          
          # 复制所有可能的 U-Boot/FIP 文件
          cp bin/targets/mediatek/filogic/uboot* ${{ github.workspace }}/uboot_fip/ 2>/dev/null || true
          cp bin/targets/mediatek/filogic/fip* ${{ github.workspace }}/uboot_fip/ 2>/dev/null || true
          
          # 如果没有找到文件，尝试从 build_dir 中查找
          if [ -z "$(ls -A ${{ github.workspace }}/uboot_fip)" ]; then
            echo "尝试从 build_dir 查找 U-Boot/FIP 文件..."
            find build_dir -name "*.bin" -type f | grep -E "(uboot|fip|u-boot)" | head -20 | while read file; do
              echo "Found: $file"
              cp "$file" ${{ github.workspace }}/uboot_fip/ 2>/dev/null || true
            done
          fi
          
          # 列出最终的文件
          echo "U-Boot/FIP 目录内容:"
          ls -la ${{ github.workspace }}/uboot_fip/

      - name: 打包个人软件源
        # yamllint disable rule:line-length
        run: |
          # 1. 进入编译产物的 packages 目录
          cd ${{ github.workspace }}/immortalwrt/bin/targets/mediatek/filogic/packages
          # 2. （重要！）为这个目录生成 opkg 索引文件
          if ${{ github.workspace }}/immortalwrt/staging_dir/host/bin/opkg-make-index . > Packages; then
            echo "Package index created successfully"
            gzip -c Packages > Packages.gz
          else
            echo "Error: Failed to create package index"
            exit 1
          fi
          # 3. 将这个目录打包成单独的"软件源"压缩包，便于下载
          cd ..
          tar -czvf my_custom_feed.tar.gz packages/
        # yamllint enable rule:line-length

      - name: 上传 U-Boot 和 FIP 文件
        uses: actions/upload-artifact@v4
        with:
          name: uboot-fip-files
          path: ${{ github.workspace }}/uboot_fip/
          retention-days: 90
        if: success()

      - name: 上传软件源包
        uses: actions/upload-artifact@v4
        with:
          name: my_custom_feed
          # yamllint disable-line rule:line-length
          path: ${{ github.workspace }}/immortalwrt/bin/targets/mediatek/filogic/my_custom_feed.tar.gz
          retention-days: 90

      - name: 上传完整固件和编译产物
        uses: actions/upload-artifact@v4
        with:
          name: firmware-zbt-z8102ax-v2-512m
          path: |
            immortalwrt/bin/targets/mediatek/filogic/
            immortalwrt/build_dir/target-aarch64_cortex-a53_musl/linux-mediatek_filogic/
          retention-days: 7
        if: success()

      - name: 创建刷机说明
        run: |
          cat > ${{ github.workspace }}/FLASH_INSTRUCTIONS.md << 'EOF'
          # ZBT Z8102AX V2 (512MB) 刷机说明

          ## 文件说明
          
          1. **U-Boot 文件**: 用于底层引导
          2. **FIP 文件**: Firmware Image Package，包含信任固件
          3. **factory.bin**: 出厂固件（首次刷机使用）
          4. **sysupgrade.bin**: 升级固件（已有 OpenWrt/ImmortalWrt 时使用）
          
          ## 刷机步骤
          
          ### 首次刷机（从原厂固件）:
          1. 进入原厂固件 WEB 界面
          2. 上传并刷入 factory.bin
          3. 等待重启
          
          ### 使用 U-Boot 刷机（救砖）:
          1. 电脑设置固定 IP: 192.168.1.2，子网掩码: 255.255.255.0
          2. 路由器断电，按住 RESET 键通电
          3. 等待约 5 秒，LED 闪烁后松开 RESET
          4. 浏览器访问 http://192.168.1.1
          5. 上传并刷入 factory.bin
          
          ### 升级刷机:
          1. 进入现有 OpenWrt/ImmortalWrt WEB 界面
          2. 系统 -> 备份/升级
          3. 上传并刷入 sysupgrade.bin
          4. 不保留配置刷机
          
          ## 注意事项
          
          1. 刷机有风险，请确保电源稳定
          2. 建议首次刷机使用 factory.bin
          3. 刷机后默认 IP: 192.168.1.1
          4. 默认无密码，首次登录需设置
          
          ## 网络设置
          
          - LAN: 192.168.1.1/24
          - WAN: DHCP 自动获取
          - 无线: 默认启用，SSID: ImmortalWrt
          
          ## 包含的功能
          
          1. QModem 模组管理（4G/5G 模块支持）
          2. MWAN3 多拨负载均衡
          3. USB 网络支持（RNDIS/QMI/MBIM/CDC）
          4. Argon 主题
          5. 512MB Flash 专用分区布局
          
          EOF
          
          # 复制说明文件到工件目录
          cp ${{ github.workspace }}/FLASH_INSTRUCTIONS.md ${{ github.workspace }}/uboot_fip/

      - name: 上传刷机说明
        uses: actions/upload-artifact@v4
        with:
          name: flash-instructions
          path: ${{ github.workspace }}/FLASH_INSTRUCTIONS.md
          retention-days: 90
